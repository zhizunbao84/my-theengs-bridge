name: Build Release APK

on:
  workflow_dispatch:        # 手动触发按钮

# ① 授予写权限（提交 & 推送）
permissions:
  contents: write   # 允许写仓库内容
  pull-requests: write   # 可选：若后续要开 PR

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. 拉代码
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive   # 拉 theengs-decoder

    - name: 初始化并重新添加子模块（纯 CI）
      run: |
        # 1. 若 decoder 目录不存在，重新添加子模块
        cd app/src/main/cpp
        if [ ! -d theengs-decoder ]; then
          git submodule add https://github.com/theengs/decoder.git theengs-decoder
        fi

        # 2. 初始化 & 拉取子模块
        git submodule update --init --recursive

        # 3. 进入子模块，检出默认分支（自动检测）
        cd theengs-decoder
        default_branch=$(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@')
        echo $default_branch
        git pull origin "$default_branch"
        cd ..

        # 4. 记录子模块 commit 并提交
        git add theengs-decoder
        git diff --cached --quiet || (
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "ci: add/update theengs-decoder submodule"
          git push
        )
        
        cd theengs-decoder/src
        if [ ! -d arduino_json ]; then
          git submodule add https://github.com/bblanchon/ArduinoJson.git arduino_json
        fi

        # 2. 初始化 & 拉取子模块
        git submodule update --init --recursive

        # 3. 进入子模块，检出默认分支（自动检测）
        cd arduino_json
        default_branch=$(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@')
        echo $default_branch
        git pull origin "$default_branch"
        cd ..

        # 4. 记录子模块 commit 并提交
        git add arduino_json
        git diff --cached --quiet || (
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "ci: add/update arduino_json submodule"
          git push
        )

    - name: Verify submodule exist
      run: |
        echo "=== 查看 decoder 目录 ==="
        ls -la app/src/main/cpp/theengs-decoder/
        echo "=== 查看 decoder/.git ==="
        cat decoder/.git 2>/dev/null || echo "（无 .git 文件，可能是 gitlink）"
        echo "=== 查看子模块提交 ==="
        git -C app/src/main/cpp/theengs-decoder rev-parse HEAD
        
        echo "=== 查看 decoder 目录 ==="
        ls -la app/src/main/cpp/theengs-decoder/src/arduino_json
        echo "=== 查看 decoder/.git ==="
        cat decoder/.git 2>/dev/null || echo "（无 .git 文件，可能是 gitlink）"
        echo "=== 查看子模块提交 ==="
        git -C app/src/main/cpp/theengs-decoder/src/arduino_json rev-parse HEAD

    # 2. 配置 JDK 17（AGP 8.x 必需）
    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # 3. 缓存 Gradle 依赖 & 构建缓存
    - name: Cache Gradle
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          ~/.gradle/native
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    # 4. 缓存 NDK（避免每次下载 1 GB）
    - name: Cache NDK
      uses: actions/cache@v4
      id: ndk-cache
      with:
        path: /usr/local/lib/android/sdk/ndk/25.2.9519653
        key: ${{ runner.os }}-ndk-25.2.9519653

    # 5. 安装 Android SDK 命令行工具 & NDK
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    - name: Install NDK
      if: steps.ndk-cache.outputs.cache-hit != 'true'
      run: sdkmanager --install "ndk;25.2.9519653"

    # ③ 2025 官方推荐：自动安装完整 Gradle 8.x 并缓存
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        gradle-version: '8.1.1'   # 指定版本，可选

    # ③ 用本地 gradle 生成 wrapper（一次即可）
    - name: Generate Gradle Wrapper
      run: gradle wrapper --gradle-version 8.0

    # ④ 后续统一用 gradlew 构建（缓存、签名等不变）
    - name: Grant execute permission for gradlew
      run: chmod +x ./gradlew

    # 6. 赋予 Gradle 可执行权限
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # 7. 编译 Release APK（含 CMake 交叉编译）
    - name: Build APK
      env:
        ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/25.2.9519653
      run: ./gradlew assembleRelease --stacktrace

    # 8. 上传构建产物（unsigned）
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: theengs-bg-unsigned
        path: app/build/outputs/apk/release/app-release-unsigned.apk
