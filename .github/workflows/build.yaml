name: Build Release APK

on:
  workflow_dispatch:        # 手动触发按钮

# ① 授予写权限（提交 & 推送）
permissions:
  contents: write   # 允许写仓库内容
  pull-requests: write   # 可选：若后续要开 PR

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

    # 1. 拉代码
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive   # 拉 theengs-decoder
        fetch-depth: 0
        clean: true

    - name: 清理旧子模块残留（目录+元数据）
      run: |
        # 1. 删除 .git/modules 下所有旧子模块元数据（彻底清除旧配置）
        rm -rf .git/modules/*    
        
        # 3. 同步 .gitmodules 最新配置到本地（关键：让Git识别新路径）
        git submodule sync --recursive

    ########################################################################
    # 步骤 3：缓存新子模块（密钥自动更新，因为 .gitmodules 已改）
    ########################################################################
    - name: 缓存新路径子模块
      uses: actions/cache@v3
      id: submodule-cache
      with:
        path: |
          .git/modules                # 新的子模块元数据目录（自动生成）
          app/src/main/cpp/decoder          # 【必须改】你的「新子模块路径1」
          app/src/main/cpp/decoder/src/arduino_json         # 【必须改】你的「新子模块路径2」（没有则删除）
        # 密钥自动失效：因为 .gitmodules 改了，hashFiles 结果变了，旧缓存不会命中
        key: ${{ runner.os }}-submodules-${{ hashFiles('.gitmodules') }}
        restore-keys: ${{ runner.os }}-submodules-

    ########################################################################
    # 步骤 4：重新拉取新路径子模块（缓存未命中，必然执行）
    ########################################################################
    - name: 重新拉取新路径子模块
      #if: steps.submodule-cache.outputs.cache-hit != 'true'
      run: |      
        # 重新初始化并递归拉取新路径子模块（--init 初始化新路径，--recursive 拉嵌套子模块）
        git submodule update --init --recursive

    ########################################################################
    # 步骤 5：验证新子模块是否拉取成功（可选，用于调试）
    ########################################################################
    - name: 验证新子模块路径
      run: |
        echo "当前子模块列表："
        git submodule  # 输出子模块信息，确认路径是新的
        echo "新子模块目录是否存在："
        ls -l app/src/main/cpp/decoder  # 替换为新路径，确认目录存在



    # 2. 配置 JDK 17（AGP 8.x 必需）
    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # 3. 缓存 Gradle 依赖 & 构建缓存
    - name: Cache Gradle
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          ~/.gradle/native
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    # 4. 缓存 NDK（避免每次下载 1 GB）
    - name: Cache NDK
      uses: actions/cache@v4
      id: ndk-cache
      with:
        path: /usr/local/lib/android/sdk/ndk/25.2.9519653
        key: ${{ runner.os }}-ndk-25.2.9519653

    # 5. 安装 Android SDK 命令行工具 & NDK
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    - name: Install NDK
      if: steps.ndk-cache.outputs.cache-hit != 'true'
      run: sdkmanager --install "ndk;25.2.9519653"

    # ③ 2025 官方推荐：自动安装完整 Gradle 8.x 并缓存
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        gradle-version: '8.1.1'   # 指定版本，可选

    # ③ 用本地 gradle 生成 wrapper（一次即可）
    - name: Generate Gradle Wrapper
      run: gradle wrapper --gradle-version 8.0

    # 6. 赋予 Gradle 可执行权限
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # 7. 编译 Release APK（含 CMake 交叉编译）
    - name: Build APK
      env:
        ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/25.2.9519653
      run: ./gradlew assembleRelease --stacktrace

    # 8. 上传构建产物（unsigned）
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: theengs-bg-unsigned
        path: app/build/outputs/apk/release/app-release-unsigned.apk
