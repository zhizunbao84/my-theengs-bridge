name: 拉取子模块
on: workflow_dispatch

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:  # 全局环境变量，所有步骤的 Git 命令都会生效
      GIT_TRACE: 1
      GIT_CURL_VERBOSE: 1
    steps:
      - name: Checkout 主仓库
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          clean: true

      - name: 验证 .gitmodules 是否存在
        run: |
          echo "查看主仓库根目录文件："
          ls -la  # 确认 .gitmodules 在列表中
          echo "查看 .gitmodules 内容："
          cat .gitmodules  # 确认内容与本地一致

      - name: 同步子模块配置并初始化
        run: |
          # 1. 同步 .gitmodules 到本地 .git/config（递归处理嵌套子模块）
          echo "同步子模块配置..."
          git submodule sync --recursive
          
          # 2. 初始化子模块（加载配置，无 -v 参数）
          echo "初始化子模块..."
          git submodule init  # 正确格式：无 -v
          
          # 3. 验证初始化结果（可选，查看本地配置）
          echo "查看子模块配置是否加载成功："
          git config --get-regexp submodule  # 输出所有子模块配置，确认包含 decoder

      - name: 拉取子模块（带详细日志）
        run: |
          # 公开仓库无需鉴权，私有仓库需添加GITHUB_TOKEN配置
          git submodule update --init --recursive --force -v  # -v 显示详细拉取过程

      - name: 验证子模块
        run: |
          echo "子模块列表："
          git submodule
          echo "子模块目录内容："
          ls -la app/src/main/cpp/decoder
