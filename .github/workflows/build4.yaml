name: 拉取子模块
on: workflow_dispatch

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:  # 全局环境变量，所有步骤的 Git 命令都会生效
      GIT_TRACE: 1
      GIT_CURL_VERBOSE: 1
    steps:
      - name: Checkout 主仓库
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          clean: true

      - name: 验证 .gitmodules 是否存在
        run: |
          echo "查看主仓库根目录文件："
          ls -la  # 确认 .gitmodules 在列表中
          echo "查看 .gitmodules 内容："
          cat .gitmodules  # 确认内容与本地一致

      - name: 同步、初始化并拉取子模块
        run: |
          git submodule add https://github.com/theengs/decoder.git app/src/main/cpp/decoder
          # 同步配置
          echo "同步子模块配置..."
          git submodule sync --recursive
          
          # 初始化子模块（加载配置）
          echo "初始化子模块..."
          git submodule init
          
          # 强制拉取子模块代码（--force 确保覆盖异常状态）
          echo "拉取子模块代码..."
          git submodule update --init --recursive --force
          
          # 再次验证配置是否加载
          echo "验证子模块配置："
          git config --get-regexp submodule
          
          # 验证子模块目录是否存在
          echo "验证子模块目录："
          ls -la app/src/main/cpp/decoder
